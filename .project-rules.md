# Vihaan Swim Tracker - Project Rules

## Repository Information
- **Website**: https://yvh1223.github.io/vihaan-swim-tracker/
- **GitHub**: https://github.com/yvh1223/vihaan-swim-tracker
- **Git Email**: yvh1223@gmail.com

## Technology Stack
- Static website hosted on GitHub Pages
- Supabase MCP for database access and modifications
- Playwright MCP for UI testing and verification
- Puppeteer MCP for web scraping automation
- Chart.js for data visualization
- Node.js scripts for data scraping and import

## Database Structure
### Swimmers Table
- `id`: Unique swimmer identifier
- `first_name`, `last_name`, `full_name`: Swimmer names
- `current_age`: Current age (must be kept updated)
- `gender`: 'Girls' or 'Boys' (used for time standards lookup)
- `lsc`, `club`: Location and team information

### Competition Results Table
- `swimmer_id`: FK to swimmers table
- `event_name`: Full event name including course type (e.g., "50 FR SCY", "100 BK LCM")
- `event_date`: Date of competition
- `time_seconds`: Time in seconds (lower is better)
- `age`: Swimmer's age at time of event
- `time_standard`: Stored standard (B, BB, A, AA, AAA, AAAA) - may be outdated
- `course_type`: SCY, LCM, or SCM

### Time Standards Table
- **CRITICAL**: Standards must be ordered correctly (B > BB > A > AA > AAA > AAAA in seconds)
- `age_group`: '10 & under', '11-12', '13-14', '15-16', '17-18'
- `gender`: 'Girls' or 'Boys'
- `event_name`: Base event name WITHOUT course type (e.g., "50 FR", "100 BK")
- `course_type`: SCY, LCM, or SCM (MUST be included in lookups)
- `b_standard` through `aaaa_standard`: Time thresholds in seconds

### Team Progression Table
- `swimmer_id`: FK to swimmers table
- `team_name`: Name of team/club
- `start_date`, `end_date`: Duration of membership
- Used for "My Journey" timeline visualization

## Critical Data Issues & Solutions

### Issue 1: Inverted Time Standards (Discovered Jan 2025)
**Problem**: All Girls time standards were stored backwards (B < AAAA instead of B > AAAA)
**Root Cause**: Data import error - standards were reversed during initial database setup
**Impact**: Achievement badges showed at wrong positions, projections calculated incorrectly
**Solution**: Created fix_inverted_standards.html to swap all 259 Girls standards
**Prevention**: Always verify standard ordering when importing new data (B should be SLOWEST time)

### Issue 2: Course Type Not Included in Standard Lookups
**Problem**: SCY standards were being applied to LCM/SCM events
**Root Cause**: Code used `eventName` as lookup key instead of `eventName_courseType`
**Impact**: Incorrect achievement calculations and projection targets
**Solution**: Modified all standard lookups to use `${baseEvent}_${courseType}` key format
**Files Modified**:
- `/js/app-new.js:489` - Store standards with course type key
- `/js/app-new.js:573` - Projection target lookups
- `/js/app-new.js:644` - Reference marker lookups
- `/js/app-new.js:811` - Achievement badge calculations

### Issue 3: My Journey Section Visibility
**Problem**: My Journey section shown for all swimmers even when no team data exists
**Solution**: Hide `.timeline-section` element when `teams.length === 0`
**Location**: `/js/app-new.js:2157-2166`

## Code Patterns & Best Practices

### Time Standard Lookups (CRITICAL PATTERN)
```javascript
// ALWAYS extract course type and use in lookup key
const baseEvent = event.replace(/\s+(SCY|LCM|SCM)$/, '');
const courseMatch = event.match(/\s+(SCY|LCM|SCM)$/);
const courseType = courseMatch ? courseMatch[1] : 'SCY';
const standardsKey = `${baseEvent}_${courseType}`;
const standards = allTimeStandards[ageGroup][standardsKey];
```

### Age Group Calculation
```javascript
let ageGroup = '10 & under';
if (age >= 13) ageGroup = '13-14';
else if (age >= 11) ageGroup = '11-12';
```

### Gender Normalization
```javascript
const genderForDB = gender === 'F' || gender === 'Girls' ? 'Girls' : 'Boys';
```

### Time Standard Comparison
```javascript
// Lower time is better in swimming
if (timeSeconds <= targetTime) {
    // Swimmer achieved this standard
}
```

## Multi-Swimmer Support

### Adding New Swimmers
1. Add to `swimmers` table with correct `current_age` and `gender`
2. Import competition results with accurate `age` and `course_type` fields
3. Verify time standards exist for swimmer's age group and gender
4. Test chart rendering with dropdown selection
5. Verify My Journey section hides if no team data

### Data Import Process

#### Master Scraper System (RECOMMENDED)
**Primary Tool**: `/scripts/master_scraper.js` - Comprehensive automation for incremental and full historical loads

**Quick Start**:
```bash
# Check what will be scraped (no actual scraping)
node scripts/master_scraper.js scripts/lac_swimmers_master.json --check-only

# Run weekly incremental updates (RECOMMENDED)
node scripts/master_scraper.js scripts/lac_swimmers_master.json

# Force full rescrape (if needed)
node scripts/master_scraper.js scripts/lac_swimmers_master.json --full
```

**Master Scraper Features**:
- ✅ **Intelligent Load Detection**: Automatically determines incremental vs. full scrape
- ✅ **90-Day Threshold Logic**: Recent events (<90 days) = incremental, old events (≥90 days) = full
- ✅ **Batch Processing**: Sequential processing with built-in rate limiting (5s delays)
- ✅ **Team Progression**: Automatic "LAC - Gold I Swim Team" management
- ✅ **Duplicate Prevention**: SHA-256 hashing prevents duplicate records
- ✅ **Comprehensive Logging**: Individual logs per swimmer + JSON reports
- ✅ **Resume Capability**: Tracks failed batches for retry
- ✅ **Multiple Modes**: Auto, full, incremental, check-only

**Decision Logic**:
| Condition | Action |
|-----------|--------|
| Swimmer not in DB | **FULL** scrape (all historical data) |
| Last event < 90 days ago | **INCREMENTAL** scrape (recent data) |
| Last event ≥ 90 days ago | **FULL** scrape (may have old data) |
| `--full` flag | **FULL** scrape (forced) |
| `--incremental` flag | **INCREMENTAL** only |

**Configuration Files**:
- `/scripts/lac_swimmers_master.json` - Production swimmer list (6 LAC swimmers)
- `/scripts/MASTER_SCRAPER_README.md` - Complete documentation
- `/scripts/LAC_PROJECT_COMPLETION_SUMMARY.md` - Project overview and quick reference

#### Individual Scraper Components (Low-Level)
**Source**: https://data.usaswimming.org/datahub/usas/individualsearch

**Scripts** (called by master_scraper.js):
- `scripts/scrape_usa_swimming_v2.js` - Single swimmer scraper with LAC auto-selection
- `scripts/load_to_supabase.js` - Database loader with duplicate detection
- `scripts/insert_lac_team_progression.js` - Team progression utility (SERVICE_ROLE key)

**Manual Workflow** (for debugging or single swimmers):
```bash
# Single swimmer
node scripts/scrape_usa_swimming_v2.js "FirstName" "LastName"

# Load into database
node scripts/load_to_supabase.js scripts/scraped_data/firstname_lastname_timestamp.json

# Add team progression
node scripts/insert_lac_team_progression.js
```

**Core Scraper Features**:
- Automatic year iteration (stops after 2 consecutive empty years)
- Screenshot capture for debugging (`scripts/screenshots/`)
- Event parsing: Extracts distance, stroke, course type from event names
- Time conversion: Parses "35.18" or "1:21.72" format to seconds
- **Lakeside Aquatic Club (LAC) Selection**: Automatically selects LAC swimmer when multiple results found (lines 146-170)
- **Rate Limiting**: 5+ second delays required (website timeouts after 10+ consecutive scrapes)

**Data Mapping** (USA Swimming → Supabase):
- `event` → `event_name` (full event: "50 FR SCY")
- `swimTime` → `time_formatted` (display format: "35.18")
- `swimTime` → `time_seconds` (parsed to decimal seconds)
- `age` → `age` (swimmer age at competition)
- `meet` → `meet_name`
- `swimDate` → `event_date` (converted to YYYY-MM-DD)
- `timeStandard` → `time_standard` (B, BB, A, AA, AAA, AAAA)
- `points` → `points`
- `lsc` → `lsc` (Local Swimming Committee)
- `team` → `team`

#### Critical Scraping Best Practices

**Name Formatting** (CRITICAL):
- ✅ **Correct Format**: `"firstName": "Parker"`, `"lastName": "Li"` (simple first + last only)
- ❌ **Wrong Format**: `"firstName": "Parker Li"` (includes last name)
- ❌ **Wrong Format**: `"firstName": "Brooke Anna"` (includes middle name)
- USA Swimming search is **extremely sensitive** to name format
- Master scraper enforces this format automatically

**Multiple Results Handling**:
- Scraper automatically selects "Lakeside Aquatic Club" when multiple swimmers found
- Implementation: `/scripts/scrape_usa_swimming_v2.js:146-170`
- Always verify `team` field in scraped JSON matches "Lakeside Aquatic Club"
- Check command: `jq -r '.[0].team' filename.json`

**Team Verification**:
```bash
# Check team for all scraped files
for file in scraped_data/*.json; do
  team=$(jq -r '.[0].team // "NO_DATA"' "$file")
  echo "$file -> $team"
done
```

**Rate Limiting** (CRITICAL):
- **5+ second delays** required between scrapes (enforced by master scraper)
- USA Swimming website **will timeout** after 10+ consecutive rapid scrapes
- Solution: Master scraper uses 5s delays, or increase to 10s if issues persist

**Common Issues**:
1. **Name Format Error**: Middle names or compound names fail to match
   - Solution: Use simple first + last names only (see format above)
2. **Navigation Timeout**: Rate limiting triggered
   - Solution: Master scraper handles this automatically with 5s delays
3. **Wrong Team Selected**: Generic names may match wrong swimmer
   - Solution: Verify team field, use master scraper's team progression feature

**Scheduled Updates** (RECOMMENDED):
```bash
# Weekly cron job (every Sunday at 2 AM)
0 2 * * 0 cd /path/to/scripts && node master_scraper.js lac_swimmers_master.json >> weekly_scrape.log 2>&1
```

#### Manual Data Validation
1. Use service role key for database imports (never commit credentials)
2. Verify imported data:
   - **Check team field**: Must be "Lakeside Aquatic Club" for LAC swimmers
   - Check age values match swimmer current age
   - Verify course types (SCY/LCM/SCM) match event names
   - Confirm time standards are NOT inverted (B > BB > A in seconds)
   - Validate date formats (YYYY-MM-DD)
3. Test UI rendering for new swimmer

## Development Workflow
1. Make website changes locally
2. Test using Playwright MCP for UI verification
3. Verify data changes using Supabase MCP
4. Test with multiple swimmers (Vihaan, Swara)
5. Check course type handling (SCY, LCM, SCM)
6. Verify time standard calculations
7. Commit with descriptive messages
8. Push to GitHub (triggers automatic GitHub Pages deployment)

## Git Configuration
- **ALWAYS use `yvh1223@gmail.com` for commits**
- **NEVER use `yhuchchannavar@salesforce.com` for this project**
- Write clear, descriptive commit messages
- Follow conventional commit format when possible
- Do not mention about Claude contribution
- Do not use Claude Account to commit code

## Testing Requirements
- Use Playwright MCP to verify UI changes
- Check responsive design on different viewport sizes
- Ensure removed sections don't leave visual gaps

## Project Structure

### Active Scripts (Production)

**Master Scraper System**:
- `/scripts/master_scraper.js` - **Main orchestration script** (RECOMMENDED for all scraping)
- `/scripts/MASTER_SCRAPER_README.md` - Complete documentation with examples
- `/scripts/LAC_PROJECT_COMPLETION_SUMMARY.md` - Project overview and quick reference
- `/scripts/lac_swimmers_master.json` - Production swimmer list (6 LAC swimmers)

**Core Components** (called by master_scraper.js):
- `/scripts/scrape_usa_swimming_v2.js` - Individual swimmer scraper with LAC auto-selection
- `/scripts/load_to_supabase.js` - Database loader with duplicate detection
- `/scripts/insert_lac_team_progression.js` - Team progression utility (SERVICE_ROLE key)

**Utilities**:
- `/scripts/get_table_columns.js` - Database schema inspection tool

**Output Directories**:
- `/scripts/scraped_data/` - JSON files with competition results
- `/scripts/logs/` - Detailed logs for each scraper run
- `/scripts/reports/` - JSON reports with scraping history and statistics
- `/scripts/screenshots/` - Debug screenshots from scraper

### Archive

**LAC Initial Scraping** (Nov 2-3, 2025):
- `/scripts/archive/lac-initial-scraping/` - Initial scraping project files
  - `scripts/` - Obsolete batch scraper and team progression scripts
  - `configs/` - Various swimmer configuration attempts
  - `docs/` - Initial project documentation
  - `README.md` - Archive documentation and migration guide

**Other Archives**:
- `/archive/debugging-tools/` - HTML utilities for data fixes (no longer needed)
- `/archive/old-scripts/` - Superseded scripts and logs
- `/archive/README.md` - Archive documentation

## Code Standards
- Maintain existing code style and formatting
- Keep changes minimal and focused
- Test before committing
- Document any significant changes
- Archive obsolete files instead of deleting them

## Database Schema Optimization Notes

### Current Schema Alignment
The database schema properly supports scraped USA Swimming data with these mappings:
- ✅ `event_name` stores full event with course ("50 FR SCY")
- ✅ `course_type`, `distance`, `stroke` parsed from event_name
- ✅ `time_formatted` stores display format from USA Swimming
- ✅ `time_seconds` stores decimal seconds for calculations
- ✅ `age` stores swimmer age at competition
- ✅ `time_standard` stores achievement level (B, BB, A, AA, AAA, AAAA)
- ✅ `meet_name`, `event_date`, `points`, `lsc`, `team` all supported

### No Changes Needed
The competition_results table schema is well-designed and matches scraped data structure. No additional columns or modifications required at this time.
