<!DOCTYPE html>
<html>
<head>
    <title>Fix View Event Name Mismatch</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
        }
        .button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 0;
        }
        .button:hover { background: #c82333; }
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .verify-button {
            background: #28a745;
        }
        .verify-button:hover { background: #218838; }
        pre {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            max-height: 600px;
            overflow-y: auto;
            font-size: 13px;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #2a5298; }
        .warning { color: #ffc107; }
        .critical {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #ffc107;
        }
    </style>
</head>
<body>
    <h1>Fix View Event Name Mismatch</h1>

    <div class="critical">
        <h3>‚ö†Ô∏è CRITICAL FIX: Event Name Mismatch</h3>
        <p><strong>Problem:</strong> competition_results stores event names like "100 BK SCY" (with course type), but time_standards expects "100 BK" (without course type).</p>
        <p><strong>Solution:</strong> Recreate database views to strip course type suffix before calling RPC functions.</p>
        <ol>
            <li>Drop existing progress_report and competition_results_with_standards views</li>
            <li>Recreate views with REGEXP_REPLACE to strip course type suffix</li>
            <li>RPC functions will now find matching records in time_standards</li>
            <li>Gap analysis charts will populate correctly</li>
        </ol>
    </div>

    <button class="button" onclick="fixViews()" id="fixBtn">Execute SQL Fix</button>
    <button class="button verify-button" onclick="verifyFix()" id="verifyBtn">Verify Fix</button>

    <h2>Output:</h2>
    <pre id="output"></pre>

    <script>
        // Service role key for DDL operations
        const SERVICE_ROLE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd3cXdwaWNidGthbW9qd3dsbWxwIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MDI4OTczMCwiZXhwIjoyMDc1ODY1NzMwfQ.yeogkX6imUHwudhlaIDpsAZzhwEXO8uuegTdrFKEZoA';

        const supabase = window.supabase.createClient(
            'https://gwqwpicbtkamojwwlmlp.supabase.co',
            SERVICE_ROLE_KEY
        );

        const output = document.getElementById('output');

        function log(message, className = 'info') {
            const line = document.createElement('div');
            line.className = className;
            line.textContent = message;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }

        async function fixViews() {
            const btn = document.getElementById('fixBtn');
            btn.disabled = true;
            output.innerHTML = '';

            try {
                log('üîß FIXING VIEW EVENT NAME MISMATCH', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                log('', 'info');
                log('‚ö†Ô∏è  This requires manual SQL execution in Supabase SQL Editor', 'warning');
                log('', 'info');
                log('INSTRUCTIONS:', 'info');
                log('1. Open Supabase Dashboard ‚Üí SQL Editor', 'info');
                log('2. Copy the content of scripts/fix_event_name_mismatch.sql', 'info');
                log('3. Paste and run in SQL Editor', 'info');
                log('4. Come back here and click "Verify Fix"', 'info');
                log('', 'info');
                log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'info');
                log('SQL TO EXECUTE (copy this):', 'info');
                log('', 'info');

                const fullSql = `-- Drop existing views
DROP VIEW IF EXISTS progress_report CASCADE;
DROP VIEW IF EXISTS competition_results_with_standards CASCADE;

-- Recreate competition_results_with_standards view with fixed event names
CREATE OR REPLACE VIEW competition_results_with_standards AS
SELECT
    cr.id,
    cr.swimmer_id,
    cr.event_name,
    cr.event_date,
    cr.time_seconds,
    cr.age,
    cr.course_type,
    cr.meet_name,
    cr.points,
    cr.time_standard as stored_time_standard,
    s.full_name,
    s.gender,
    s.current_age,
    -- Strip course type suffix before calling RPC function
    get_current_standard(
        REGEXP_REPLACE(cr.event_name, ' (SCY|LCM|SCM)$', ''),
        cr.time_seconds,
        cr.age,
        COALESCE(s.gender, 'Boys'),
        cr.course_type
    ) as calculated_time_standard
FROM competition_results cr
LEFT JOIN swimmers s ON cr.swimmer_id = s.id
ORDER BY cr.event_date DESC, cr.event_name;

-- Recreate progress_report view with fixed event names
CREATE OR REPLACE VIEW progress_report AS
SELECT
    lt.swimmer_id,
    s.full_name as swimmer_name,
    lt.event_name,
    lt.event_date as latest_swim_date,
    lt.time_formatted as current_time,
    lt.time_seconds,
    -- Strip course type suffix before calling RPC functions
    get_current_standard(
        REGEXP_REPLACE(lt.event_name, ' (SCY|LCM|SCM)$', ''),
        lt.time_seconds,
        COALESCE(s.current_age, 10),
        COALESCE(s.gender, 'Boys'),
        lt.course_type
    ) as current_standard,
    (SELECT next_level FROM get_next_standard_info(
        REGEXP_REPLACE(lt.event_name, ' (SCY|LCM|SCM)$', ''),
        lt.time_seconds,
        COALESCE(s.current_age, 10),
        COALESCE(s.gender, 'Boys'),
        lt.course_type
    )) as next_standard,
    format_time((SELECT target_time FROM get_next_standard_info(
        REGEXP_REPLACE(lt.event_name, ' (SCY|LCM|SCM)$', ''),
        lt.time_seconds,
        COALESCE(s.current_age, 10),
        COALESCE(s.gender, 'Boys'),
        lt.course_type
    ))) as next_target_time,
    (SELECT gap_seconds FROM get_next_standard_info(
        REGEXP_REPLACE(lt.event_name, ' (SCY|LCM|SCM)$', ''),
        lt.time_seconds,
        COALESCE(s.current_age, 10),
        COALESCE(s.gender, 'Boys'),
        lt.course_type
    )) as gap_seconds,
    (SELECT improvement_pct FROM get_next_standard_info(
        REGEXP_REPLACE(lt.event_name, ' (SCY|LCM|SCM)$', ''),
        lt.time_seconds,
        COALESCE(s.current_age, 10),
        COALESCE(s.gender, 'Boys'),
        lt.course_type
    )) as improvement_pct
FROM latest_times_per_event lt
JOIN swimmers s ON lt.swimmer_id = s.id
ORDER BY lt.event_name;

-- Grant permissions
GRANT SELECT ON competition_results_with_standards TO anon, authenticated;
GRANT SELECT ON progress_report TO anon, authenticated;`;

                // Create a copyable text area
                const textarea = document.createElement('textarea');
                textarea.value = fullSql;
                textarea.style.width = '100%';
                textarea.style.height = '300px';
                textarea.style.fontFamily = 'monospace';
                textarea.style.fontSize = '11px';
                output.appendChild(textarea);

                // Add copy button
                const copyBtn = document.createElement('button');
                copyBtn.textContent = 'Copy SQL to Clipboard';
                copyBtn.className = 'button';
                copyBtn.style.marginTop = '10px';
                copyBtn.onclick = () => {
                    textarea.select();
                    document.execCommand('copy');
                    copyBtn.textContent = '‚úÖ Copied!';
                    setTimeout(() => { copyBtn.textContent = 'Copy SQL to Clipboard'; }, 2000);
                };
                output.appendChild(copyBtn);

                log('', 'info');
                log('', 'info');
                log('After running the SQL, click "Verify Fix" below.', 'info');

            } catch (error) {
                log('', 'info');
                log('‚ùå ERROR: ' + error.message, 'error');
                console.error('Error:', error);
            } finally {
                btn.disabled = false;
            }
        }

        async function verifyFix() {
            output.innerHTML = '';

            try {
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                log('üîç VERIFYING FIX', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                log('', 'info');

                log('1. Testing progress_report view...', 'info');

                const { data: progressData, error: progressError } = await supabase
                    .from('progress_report')
                    .select('*')
                    .eq('swimmer_id', 1)
                    .limit(5);

                if (progressError) throw progressError;

                log(`   Found ${progressData.length} events`, 'info');
                log('', 'info');

                let nullCount = 0;
                let validCount = 0;

                progressData.forEach(item => {
                    log(`   ${item.event_name}:`, 'info');
                    log(`      Current: ${item.current_standard || 'NULL'}`, item.current_standard ? 'success' : 'error');
                    log(`      Next: ${item.next_standard || 'NULL'}`, item.next_standard ? 'success' : 'error');
                    log(`      Gap: ${item.gap_seconds || 'NULL'}`, item.gap_seconds ? 'success' : 'error');

                    if (!item.current_standard || !item.next_standard) {
                        nullCount++;
                    } else {
                        validCount++;
                    }
                });

                log('', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');

                if (nullCount > 0) {
                    log(`‚ö†Ô∏è  WARNING: ${nullCount}/${progressData.length} events still have NULL values`, 'error');
                    log('   The fix may not have been applied correctly.', 'error');
                } else {
                    log(`‚úÖ‚úÖ‚úÖ SUCCESS! ‚úÖ‚úÖ‚úÖ`, 'success');
                    log(`   All ${validCount} events have valid standards!`, 'success');
                    log('   Gap analysis charts should now work correctly.', 'success');
                    log('', 'info');
                    log('üéâ Refresh the main page to see the gap charts!', 'success');
                }

            } catch (error) {
                log('', 'info');
                log('‚ùå Verification error: ' + error.message, 'error');
                console.error('Error:', error);
            }
        }
    </script>
</body>
</html>
